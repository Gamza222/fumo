name: Deploy Preview Environment

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]

env:
  NODE_VERSION: "18"

jobs:
  # ============================================================================
  # PREVIEW DEPLOYMENT
  # ============================================================================

  deploy-preview:
    name: Deploy to Preview
    runs-on: ubuntu-latest
    environment: preview

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Get version and environment info
        run: |
          echo "=== Deployment Information ==="
          VERSION=$(npx ts-node --project tsconfig.scripts.json scripts/version.ts display)
          VERSION_INFO=$(npx ts-node --project tsconfig.scripts.json scripts/version.ts info)
          ENV=$(npx ts-node --project tsconfig.scripts.json -e "const { envConfig } = require('./config/env'); console.log(envConfig.appEnv);")
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION_INFO=$VERSION_INFO" >> $GITHUB_ENV
          echo "ENV=$ENV" >> $GITHUB_ENV
          echo "Deploying version: $VERSION"
          echo "Environment: $ENV"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"

      - name: Create build info file
        run: |
          cat > build-info.json << EOF
          {
            "version": "$VERSION",
            "versionInfo": $VERSION_INFO,
            "environment": "$ENV",
            "branch": "${{ github.ref_name }}",
            "commit": "${{ github.sha }}",
            "buildTime": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "buildUrl": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          }
          EOF
          echo "Created build-info.json:"
          cat build-info.json

      - name: Preview deployment (disabled)
        run: |
          echo "âš ï¸  Preview deployment is currently disabled"
          echo "ðŸ“¦ Build completed successfully and is ready for deployment"
          echo "ðŸ”§ Configure deployment platform (Vercel, Netlify, etc.) to enable automatic deployment"
          echo "ðŸ“‹ Build info:"
          cat build-info.json

      - name: Comment PR with build status
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## ðŸš€ Preview Build Ready

            **Version:** ${{ env.VERSION }}
            **Environment:** ${{ env.ENV }}
            **Branch:** ${{ github.ref_name }}
            **Commit:** ${{ github.sha }}

            **Status:** âœ… Build completed successfully
            **Deployment:** âš ï¸ Currently disabled - configure deployment platform to enable

            **Build Info:**
            - Build Time: $(date -u +%Y-%m-%dT%H:%M:%SZ)
            - Build URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            **Next Steps:**
            - Configure deployment platform (Vercel, Netlify, etc.)
            - Set up required secrets and environment variables
            - Enable deployment in workflow files`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: Notify deployment success
        if: success()
        run: |
          echo "âœ… Preview deployment successful"
          echo "Version: $VERSION"
          echo "Environment: $ENV"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Build URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
