{"file":"/Users/gamzaramazanov/Desktop/fumo/src/infrastructure/security/lib/security-headers/security-headers.middleware.ts","mappings":"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","names":[],"sources":["/Users/gamzaramazanov/Desktop/fumo/src/infrastructure/security/lib/security-headers/security-headers.middleware.ts"],"sourcesContent":["/**\n * Security Headers Middleware\n *\n * Middleware for setting security headers in Next.js applications.\n * Universal security headers middleware for enterprise applications.\n */\n\nimport { NextRequest, NextResponse } from 'next/server';\nimport { securityConfig } from '../security-config';\n\n// ============================================================================\n// SECURITY HEADERS MIDDLEWARE\n// ============================================================================\n\n/**\n * Apply security headers to response\n */\nexport function applySecurityHeaders(response: NextResponse): NextResponse {\n  const headers = securityConfig.headers;\n\n  // Apply all security headers\n  Object.entries(headers).forEach(([key, value]) => {\n    if (value) {\n      response.headers.set(key, value as string);\n    }\n  });\n\n  return response;\n}\n\n/**\n * Generate CSP nonce for inline scripts/styles\n */\nexport function generateNonce(): string {\n  const array = new Uint8Array(16);\n  crypto.getRandomValues(array);\n  return Array.from(array, (byte) => byte.toString(16).padStart(2, '0')).join('');\n}\n\n/**\n * Update CSP with nonce\n */\nexport function updateCSPWithNonce(nonce: string): string {\n  const baseCSP = securityConfig.headers['Content-Security-Policy'];\n\n  if (!baseCSP) {\n    return '';\n  }\n\n  // Add nonce to script-src and style-src\n  return baseCSP\n    .replace(\"script-src 'self'\", `script-src 'self' 'nonce-${nonce}'`)\n    .replace(\"style-src 'self'\", `style-src 'self' 'nonce-${nonce}'`);\n}\n\n/**\n * Report CSP violations\n */\nexport function reportCSPViolation(violation: unknown): void {\n  // 1. Log the violation\n  console.error('CSP Violation:', violation);\n\n  // 2. Log it to your security monitoring system\n  // eslint-disable-next-line no-console\n  console.log('CSP Violation Report:', {\n    timestamp: new Date().toISOString(),\n    blockedURI: (violation as { blockedURI?: string })?.blockedURI,\n    documentURI: (violation as { documentURI?: string })?.documentURI,\n    violatedDirective: (violation as { violatedDirective?: string })?.violatedDirective,\n    effectiveDirective: (violation as { effectiveDirective?: string })?.effectiveDirective,\n    originalPolicy: (violation as { originalPolicy?: string })?.originalPolicy,\n    referrer: (violation as { referrer?: string })?.referrer,\n    sourceFile: (violation as { sourceFile?: string })?.sourceFile,\n    lineNumber: (violation as { lineNumber?: number })?.lineNumber,\n    columnNumber: (violation as { columnNumber?: number })?.columnNumber,\n  });\n\n  // 3. Send alerts for critical violations (in production)\n}\n\n/**\n * Check if request is suspicious\n */\nexport function isSuspiciousRequest(request: NextRequest): boolean {\n  const userAgent = request.headers.get('user-agent') || '';\n  const origin = request.headers.get('origin') || '';\n  const referer = request.headers.get('referer') || '';\n\n  // Block requests with suspicious user agents\n  const suspiciousUserAgents = ['sqlmap', 'nikto', 'nmap', 'masscan', 'zap', 'burp'];\n\n  const isSuspiciousUA = suspiciousUserAgents.some((ua) =>\n    userAgent.toLowerCase().includes(ua.toLowerCase())\n  );\n\n  if (isSuspiciousUA) {\n    return true;\n  }\n\n  // Block requests from suspicious origins\n  const suspiciousOrigins = ['localhost:8080', '127.0.0.1:8080', '0.0.0.0:8080'];\n\n  const isSuspiciousOrigin = suspiciousOrigins.some(\n    (susOrigin) => origin.includes(susOrigin) || referer.includes(susOrigin)\n  );\n\n  return isSuspiciousOrigin;\n}\n\n/**\n * Main security middleware\n */\nexport function securityMiddleware(request: NextRequest): NextResponse {\n  // Check for suspicious requests\n  if (isSuspiciousRequest(request)) {\n    return new NextResponse('Forbidden', { status: 403 });\n  }\n\n  // Create response\n  const response = NextResponse.next();\n\n  // Apply security headers\n  return applySecurityHeaders(response);\n}\n\n/**\n * CORS middleware\n */\nexport function corsMiddleware(request: NextRequest): NextResponse {\n  const origin = request.headers.get('origin');\n  const method = request.headers.get('access-control-request-method');\n  const headers = request.headers.get('access-control-request-headers');\n\n  // Handle preflight requests\n  if (request.method === 'OPTIONS') {\n    const response = new NextResponse(null, { status: 200 });\n\n    if (origin && securityConfig.cors.origin.includes(origin)) {\n      response.headers.set('Access-Control-Allow-Origin', origin);\n    }\n\n    if (method) {\n      response.headers.set('Access-Control-Allow-Methods', method);\n    }\n\n    if (headers) {\n      response.headers.set('Access-Control-Allow-Headers', headers);\n    }\n\n    response.headers.set('Access-Control-Max-Age', '86400');\n    return response;\n  }\n\n  // Handle actual requests\n  const response = NextResponse.next();\n\n  if (origin && securityConfig.cors.origin.includes(origin)) {\n    response.headers.set('Access-Control-Allow-Origin', origin);\n  }\n\n  response.headers.set('Access-Control-Allow-Credentials', 'true');\n  response.headers.set('Access-Control-Allow-Methods', securityConfig.cors.methods.join(', '));\n  response.headers.set(\n    'Access-Control-Allow-Headers',\n    securityConfig.cors.allowedHeaders.join(', ')\n  );\n  response.headers.set(\n    'Access-Control-Expose-Headers',\n    securityConfig.cors.exposedHeaders.join(', ')\n  );\n  response.headers.set('Access-Control-Max-Age', securityConfig.cors.maxAge.toString());\n\n  return response;\n}\n"],"version":3}