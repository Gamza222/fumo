9478f37536a050771144316796f9ee6b
"use strict";
/**
 * Security Configuration
 *
 * Comprehensive security settings for enterprise applications.
 * Includes CSP, security headers, authentication, and authorization.
 */
var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
var __spreadArray = (this && this.__spreadArray) || function (to, from, pack) {
    if (pack || arguments.length === 2) for (var i = 0, l = from.length, ar; i < l; i++) {
        if (ar || !(i in from)) {
            if (!ar) ar = Array.prototype.slice.call(from, 0, i);
            ar[i] = from[i];
        }
    }
    return to.concat(ar || Array.prototype.slice.call(from));
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.isOriginAllowed = exports.generateSecureToken = exports.validatePassword = exports.securityConfig = void 0;
var env_1 = require("../../../../../config/env");
// ============================================================================
// ENVIRONMENT-SPECIFIC SECURITY CONFIGURATION
// ============================================================================
var getSecurityConfig = function () {
    var isProduction = process.env.NODE_ENV === env_1.Environment.Production;
    var isDevelopment = process.env.NODE_ENV === env_1.Environment.Development;
    // Base CSP policy
    var baseCSP = [
        "default-src 'self'",
        "script-src 'self' 'unsafe-inline' 'unsafe-eval'", // Next.js requires unsafe-eval in dev
        "style-src 'self' 'unsafe-inline'",
        "img-src 'self' data: blob: https:",
        "font-src 'self' data:",
        "connect-src 'self' ws: wss: https:",
        "media-src 'self'",
        "object-src 'none'",
        "base-uri 'self'",
        "form-action 'self'",
        "frame-ancestors 'none'",
    ];
    // Add development-specific CSP
    if (isDevelopment) {
        baseCSP.push("'unsafe-eval'"); // Required for Next.js dev mode
    }
    // Add production-specific CSP
    if (isProduction) {
        // Remove unsafe-inline and unsafe-eval in production
        var productionCSP = baseCSP.map(function (directive) {
            if (directive.includes('unsafe-inline') || directive.includes('unsafe-eval')) {
                return directive.replace(/ 'unsafe-inline'|'unsafe-eval'/g, '');
            }
            return directive;
        });
        baseCSP.splice.apply(baseCSP, __spreadArray([0, baseCSP.length], productionCSP, false));
    }
    return {
        headers: __assign({ 'Content-Security-Policy': baseCSP.join('; '), 'X-Frame-Options': 'DENY', 'X-Content-Type-Options': 'nosniff', 'Referrer-Policy': 'strict-origin-when-cross-origin', 'Permissions-Policy': 'camera=(), microphone=(), geolocation=(), payment=()', 'X-XSS-Protection': '1; mode=block' }, (isProduction && {
            'Strict-Transport-Security': 'max-age=31536000; includeSubDomains; preload',
        })),
        cors: {
            origin: isDevelopment
                ? ['http://localhost:3000', 'http://localhost:3001']
                : process.env.NEXT_PUBLIC_APP_URL || 'https://yourdomain.com',
            credentials: true,
            methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS'],
            allowedHeaders: [
                'Content-Type',
                'Authorization',
                'X-Requested-With',
                'Accept',
                'Origin',
                'Access-Control-Request-Method',
                'Access-Control-Request-Headers',
            ],
            exposedHeaders: ['X-Total-Count', 'X-Page-Count'],
            maxAge: 86400, // 24 hours
        },
        auth: {
            jwtSecret: process.env.JWT_SECRET || 'your-super-secret-jwt-key-change-in-production',
            jwtExpiresIn: process.env.JWT_EXPIRES_IN || '15m',
            refreshTokenExpiresIn: process.env.REFRESH_TOKEN_EXPIRES_IN || '7d',
            passwordMinLength: parseInt(process.env.PASSWORD_MIN_LENGTH || '8', 10),
            passwordRequireSpecialChars: process.env.PASSWORD_REQUIRE_SPECIAL_CHARS === 'true',
            passwordRequireNumbers: process.env.PASSWORD_REQUIRE_NUMBERS === 'true',
            passwordRequireUppercase: process.env.PASSWORD_REQUIRE_UPPERCASE === 'true',
            sessionTimeout: parseInt(process.env.SESSION_TIMEOUT || '3600000', 10), // 1 hour
        },
        rateLimit: {
            windowMs: parseInt(process.env.RATE_LIMIT_WINDOW_MS || '900000', 10), // 15 minutes
            maxRequests: parseInt(process.env.RATE_LIMIT_MAX_REQUESTS || '100', 10),
            skipSuccessfulRequests: process.env.RATE_LIMIT_SKIP_SUCCESS === 'true',
            skipFailedRequests: process.env.RATE_LIMIT_SKIP_FAILED === 'false',
        },
    };
};
exports.securityConfig = getSecurityConfig();
// ============================================================================
// SECURITY UTILITIES
// ============================================================================
/**
 * Validate password strength based on security configuration
 */
var validatePassword = function (password) {
    var config = exports.securityConfig.auth;
    var errors = [];
    if (password.length < config.passwordMinLength) {
        errors.push("Password must be at least ".concat(config.passwordMinLength, " characters long"));
    }
    if (config.passwordRequireSpecialChars && !/[!@#$%^&*(),.?":{}|<>]/.test(password)) {
        errors.push('Password must contain at least one special character');
    }
    if (config.passwordRequireNumbers && !/\d/.test(password)) {
        errors.push('Password must contain at least one number');
    }
    if (config.passwordRequireUppercase && !/[A-Z]/.test(password)) {
        errors.push('Password must contain at least one uppercase letter');
    }
    return {
        isValid: errors.length === 0,
        errors: errors,
    };
};
exports.validatePassword = validatePassword;
/**
 * Generate secure random string for tokens
 */
var generateSecureToken = function (length) {
    if (length === void 0) { length = 32; }
    var chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    var result = '';
    var array = new Uint8Array(length);
    crypto.getRandomValues(array);
    for (var i = 0; i < length; i++) {
        result += chars[(array[i] || 0) % chars.length];
    }
    return result;
};
exports.generateSecureToken = generateSecureToken;
/**
 * Check if request origin is allowed
 */
var isOriginAllowed = function (origin) {
    var config = exports.securityConfig.cors;
    var allowedOrigins = Array.isArray(config.origin) ? config.origin : [config.origin];
    return allowedOrigins.includes(origin);
};
exports.isOriginAllowed = isOriginAllowed;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2dhbXphcmFtYXphbm92L0Rlc2t0b3AvZnVtby9zcmMvaW5mcmFzdHJ1Y3R1cmUvc2VjdXJpdHkvbGliL3NlY3VyaXR5LWNvbmZpZy9zZWN1cml0eS5jb25maWcudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7OztHQUtHOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUVILGlEQUF3RDtBQUd4RCwrRUFBK0U7QUFDL0UsOENBQThDO0FBQzlDLCtFQUErRTtBQUUvRSxJQUFNLGlCQUFpQixHQUFHO0lBQ3hCLElBQU0sWUFBWSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxLQUFLLGlCQUFXLENBQUMsVUFBVSxDQUFDO0lBQ3JFLElBQU0sYUFBYSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxLQUFLLGlCQUFXLENBQUMsV0FBVyxDQUFDO0lBRXZFLGtCQUFrQjtJQUNsQixJQUFNLE9BQU8sR0FBRztRQUNkLG9CQUFvQjtRQUNwQixpREFBaUQsRUFBRSxzQ0FBc0M7UUFDekYsa0NBQWtDO1FBQ2xDLG1DQUFtQztRQUNuQyx1QkFBdUI7UUFDdkIsb0NBQW9DO1FBQ3BDLGtCQUFrQjtRQUNsQixtQkFBbUI7UUFDbkIsaUJBQWlCO1FBQ2pCLG9CQUFvQjtRQUNwQix3QkFBd0I7S0FDekIsQ0FBQztJQUVGLCtCQUErQjtJQUMvQixJQUFJLGFBQWEsRUFBRSxDQUFDO1FBQ2xCLE9BQU8sQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxnQ0FBZ0M7SUFDakUsQ0FBQztJQUVELDhCQUE4QjtJQUM5QixJQUFJLFlBQVksRUFBRSxDQUFDO1FBQ2pCLHFEQUFxRDtRQUNyRCxJQUFNLGFBQWEsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQUMsU0FBUztZQUMxQyxJQUFJLFNBQVMsQ0FBQyxRQUFRLENBQUMsZUFBZSxDQUFDLElBQUksU0FBUyxDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQUMsRUFBRSxDQUFDO2dCQUM3RSxPQUFPLFNBQVMsQ0FBQyxPQUFPLENBQUMs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QU0sQ0FBQyxlQUFlLENBQUMsS0FBSyxDQUFDLENBQUM7SUFFOUIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO1FBQ2hDLE1BQU0sSUFBSSxLQUFLLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ2xELENBQUM7SUFFRCxPQUFPLE1BQU0sQ0FBQztBQUNoQixDQUFDLENBQUM7QUFYVyxRQUFBLG1CQUFtQix1QkFXOUI7QUFFRjs7R0FFRztBQUNJLElBQU0sZUFBZSxHQUFHLFVBQUMsTUFBYztJQUM1QyxJQUFNLE1BQU0sR0FBRyxzQkFBYyxDQUFDLElBQUksQ0FBQztJQUNuQyxJQUFNLGNBQWMsR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDdEYsT0FBTyxjQUFjLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQ3pDLENBQUMsQ0FBQztBQUpXLFFBQUEsZUFBZSxtQkFJMUIiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2dhbXphcmFtYXphbm92L0Rlc2t0b3AvZnVtby9zcmMvaW5mcmFzdHJ1Y3R1cmUvc2VjdXJpdHkvbGliL3NlY3VyaXR5LWNvbmZpZy9zZWN1cml0eS5jb25maWcudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBTZWN1cml0eSBDb25maWd1cmF0aW9uXG4gKlxuICogQ29tcHJlaGVuc2l2ZSBzZWN1cml0eSBzZXR0aW5ncyBmb3IgZW50ZXJwcmlzZSBhcHBsaWNhdGlvbnMuXG4gKiBJbmNsdWRlcyBDU1AsIHNlY3VyaXR5IGhlYWRlcnMsIGF1dGhlbnRpY2F0aW9uLCBhbmQgYXV0aG9yaXphdGlvbi5cbiAqL1xuXG5pbXBvcnQgeyBFbnZpcm9ubWVudCB9IGZyb20gJy4uLy4uLy4uLy4uLy4uL2NvbmZpZy9lbnYnO1xuaW1wb3J0IHR5cGUgeyBTZWN1cml0eUNvbmZpZyB9IGZyb20gJy4uLy4uL3R5cGVzL3NlY3VyaXR5LnR5cGVzJztcblxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuLy8gRU5WSVJPTk1FTlQtU1BFQ0lGSUMgU0VDVVJJVFkgQ09ORklHVVJBVElPTlxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG5jb25zdCBnZXRTZWN1cml0eUNvbmZpZyA9ICgpOiBTZWN1cml0eUNvbmZpZyA9PiB7XG4gIGNvbnN0IGlzUHJvZHVjdGlvbiA9IHByb2Nlc3MuZW52Lk5PREVfRU5WID09PSBFbnZpcm9ubWVudC5Qcm9kdWN0aW9uO1xuICBjb25zdCBpc0RldmVsb3BtZW50ID0gcHJvY2Vzcy5lbnYuTk9ERV9FTlYgPT09IEVudmlyb25tZW50LkRldmVsb3BtZW50O1xuXG4gIC8vIEJhc2UgQ1NQIHBvbGljeVxuICBjb25zdCBiYXNlQ1NQID0gW1xuICAgIFwiZGVmYXVsdC1zcmMgJ3NlbGYnXCIsXG4gICAgXCJzY3JpcHQtc3JjICdzZWxmJyAndW5zYWZlLWlubGluZScgJ3Vuc2FmZS1ldmFsJ1wiLCAvLyBOZXh0LmpzIHJlcXVpcmVzIHVuc2FmZS1ldmFsIGluIGRldlxuICAgIFwic3R5bGUtc3JjICdzZWxmJyAndW5zYWZlLWlubGluZSdcIixcbiAgICBcImltZy1zcmMgJ3NlbGYnIGRhdGE6IGJsb2I6IGh0dHBzOlwiLFxuICAgIFwiZm9udC1zcmMgJ3NlbGYnIGRhdGE6XCIsXG4gICAgXCJjb25uZWN0LXNyYyAnc2VsZicgd3M6IHdzczogaHR0cHM6XCIsXG4gICAgXCJtZWRpYS1zcmMgJ3NlbGYnXCIsXG4gICAgXCJvYmplY3Qtc3JjICdub25lJ1wiLFxuICAgIFwiYmFzZS11cmkgJ3NlbGYnXCIsXG4gICAgXCJmb3JtLWFjdGlvbiAnc2VsZidcIixcbiAgICBcImZyYW1lLWFuY2VzdG9ycyAnbm9uZSdcIixcbiAgXTtcblxuICAvLyBBZGQgZGV2ZWxvcG1lbnQtc3BlY2lmaWMgQ1NQXG4gIGlmIChpc0RldmVsb3BtZW50KSB7XG4gICAgYmFzZUNTUC5wdXNoKFwiJ3Vuc2FmZS1ldmFsJ1wiKTsgLy8gUmVxdWlyZWQgZm9yIE5leHQuanMgZGV2IG1vZGVcbiAgfVxuXG4gIC8vIEFkZCBwcm9kdWN0aW9uLXNwZWNpZmljIENTUFxuICBpZiAoaXNQcm9kdWN0aW9uKSB7XG4gICAgLy8gUmVtb3ZlIHVuc2FmZS1pbmxpbmUgYW5kIHVuc2FmZS1ldmFsIGluIHByb2R1Y3Rpb25cbiAgICBjb25zdCBwcm9kdWN0aW9uQ1NQID0gYmFzZUNTUC5tYXAoKGRpcmVjdGl2ZSkgPT4ge1xuICAgICAgaWYgKGRpcmVjdGl2ZS5pbmNsdWRlcygndW5zYWZlLWlubGluZScpIHx8IGRpcmVjdGl2ZS5pbmNsdWRlcygndW5zYWZlLWV2YWwnKSkge1xuICAgICAgICByZXR1cm4gZGlyZWN0aXZlLnJlcGxhY2UoLyAndW5zYWZlLWlubGluZSd8J3Vuc2FmZS1ldmFsJy9nLCAnJyk7XG4gICAgICB9XG4gICAgICByZXR1cm4gZGlyZWN0aXZlO1xuICAgIH0pO1xuICAgIGJhc2VDU1Auc3BsaWNlKDAsIGJhc2VDU1AubGVuZ3RoLCAuLi5wcm9kdWN0aW9uQ1NQKTtcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgaGVhZGVyczoge1xuICAgICAgJ0NvbnRlbnQtU2VjdXJpdHktUG9saWN5JzogYmFzZUNTUC5qb2luKCc7ICcpLFxuICAgICAgJ1gtRnJhbWUtT3B0aW9ucyc6ICdERU5ZJyxcbiAgICAgICdYLUNvbnRlbnQtVHlwZS1PcHRpb25zJzogJ25vc25pZmYnLFxuICAgICAgJ1JlZmVycmVyLVBvbGljeSc6ICdzdHJpY3Qtb3JpZ2luLXdoZW4tY3Jvc3Mtb3JpZ2luJyxcbiAgICAgICdQZXJtaXNzaW9ucy1Qb2xpY3knOiAnY2FtZXJhPSgpLCBtaWNyb3Bob25lPSgpLCBnZW9sb2NhdGlvbj0oKSwgcGF5bWVudD0oKScsXG4gICAgICAnWC1YU1MtUHJvdGVjdGlvbic6ICcxOyBtb2RlPWJsb2NrJyxcbiAgICAgIC4uLihpc1Byb2R1Y3Rpb24gJiYge1xuICAgICAgICAnU3RyaWN0LVRyYW5zcG9ydC1TZWN1cml0eSc6ICdtYXgtYWdlPTMxNTM2MDAwOyBpbmNsdWRlU3ViRG9tYWluczsgcHJlbG9hZCcsXG4gICAgICB9KSxcbiAgICB9LFxuICAgIGNvcnM6IHtcbiAgICAgIG9yaWdpbjogaXNEZXZlbG9wbWVudFxuICAgICAgICA/IFsnaHR0cDovL2xvY2FsaG9zdDozMDAwJywgJ2h0dHA6Ly9sb2NhbGhvc3Q6MzAwMSddXG4gICAgICAgIDogcHJvY2Vzcy5lbnYuTkVYVF9QVUJMSUNfQVBQX1VSTCB8fCAnaHR0cHM6Ly95b3VyZG9tYWluLmNvbScsXG4gICAgICBjcmVkZW50aWFsczogdHJ1ZSxcbiAgICAgIG1ldGhvZHM6IFsnR0VUJywgJ1BPU1QnLCAnUFVUJywgJ0RFTEVURScsICdQQVRDSCcsICdPUFRJT05TJ10sXG4gICAgICBhbGxvd2VkSGVhZGVyczogW1xuICAgICAgICAnQ29udGVudC1UeXBlJyxcbiAgICAgICAgJ0F1dGhvcml6YXRpb24nLFxuICAgICAgICAnWC1SZXF1ZXN0ZWQtV2l0aCcsXG4gICAgICAgICdBY2NlcHQnLFxuICAgICAgICAnT3JpZ2luJyxcbiAgICAgICAgJ0FjY2Vzcy1Db250cm9sLVJlcXVlc3QtTWV0aG9kJyxcbiAgICAgICAgJ0FjY2Vzcy1Db250cm9sLVJlcXVlc3QtSGVhZGVycycsXG4gICAgICBdLFxuICAgICAgZXhwb3NlZEhlYWRlcnM6IFsnWC1Ub3RhbC1Db3VudCcsICdYLVBhZ2UtQ291bnQnXSxcbiAgICAgIG1heEFnZTogODY0MDAsIC8vIDI0IGhvdXJzXG4gICAgfSxcbiAgICBhdXRoOiB7XG4gICAgICBqd3RTZWNyZXQ6IHByb2Nlc3MuZW52LkpXVF9TRUNSRVQgfHwgJ3lvdXItc3VwZXItc2VjcmV0LWp3dC1rZXktY2hhbmdlLWluLXByb2R1Y3Rpb24nLFxuICAgICAgand0RXhwaXJlc0luOiBwcm9jZXNzLmVudi5KV1RfRVhQSVJFU19JTiB8fCAnMTVtJyxcbiAgICAgIHJlZnJlc2hUb2tlbkV4cGlyZXNJbjogcHJvY2Vzcy5lbnYuUkVGUkVTSF9UT0tFTl9FWFBJUkVTX0lOIHx8ICc3ZCcsXG4gICAgICBwYXNzd29yZE1pbkxlbmd0aDogcGFyc2VJbnQocHJvY2Vzcy5lbnYuUEFTU1dPUkRfTUlOX0xFTkdUSCB8fCAnOCcsIDEwKSxcbiAgICAgIHBhc3N3b3JkUmVxdWlyZVNwZWNpYWxDaGFyczogcHJvY2Vzcy5lbnYuUEFTU1dPUkRfUkVRVUlSRV9TUEVDSUFMX0NIQVJTID09PSAndHJ1ZScsXG4gICAgICBwYXNzd29yZFJlcXVpcmVOdW1iZXJzOiBwcm9jZXNzLmVudi5QQVNTV09SRF9SRVFVSVJFX05VTUJFUlMgPT09ICd0cnVlJyxcbiAgICAgIHBhc3N3b3JkUmVxdWlyZVVwcGVyY2FzZTogcHJvY2Vzcy5lbnYuUEFTU1dPUkRfUkVRVUlSRV9VUFBFUkNBU0UgPT09ICd0cnVlJyxcbiAgICAgIHNlc3Npb25UaW1lb3V0OiBwYXJzZUludChwcm9jZXNzLmVudi5TRVNTSU9OX1RJTUVPVVQgfHwgJzM2MDAwMDAnLCAxMCksIC8vIDEgaG91clxuICAgIH0sXG4gICAgcmF0ZUxpbWl0OiB7XG4gICAgICB3aW5kb3dNczogcGFyc2VJbnQocHJvY2Vzcy5lbnYuUkFURV9MSU1JVF9XSU5ET1dfTVMgfHwgJzkwMDAwMCcsIDEwKSwgLy8gMTUgbWludXRlc1xuICAgICAgbWF4UmVxdWVzdHM6IHBhcnNlSW50KHByb2Nlc3MuZW52LlJBVEVfTElNSVRfTUFYX1JFUVVFU1RTIHx8ICcxMDAnLCAxMCksXG4gICAgICBza2lwU3VjY2Vzc2Z1bFJlcXVlc3RzOiBwcm9jZXNzLmVudi5SQVRFX0xJTUlUX1NLSVBfU1VDQ0VTUyA9PT0gJ3RydWUnLFxuICAgICAgc2tpcEZhaWxlZFJlcXVlc3RzOiBwcm9jZXNzLmVudi5SQVRFX0xJTUlUX1NLSVBfRkFJTEVEID09PSAnZmFsc2UnLFxuICAgIH0sXG4gIH07XG59O1xuXG5leHBvcnQgY29uc3Qgc2VjdXJpdHlDb25maWcgPSBnZXRTZWN1cml0eUNvbmZpZygpO1xuXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4vLyBTRUNVUklUWSBVVElMSVRJRVNcbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuLyoqXG4gKiBWYWxpZGF0ZSBwYXNzd29yZCBzdHJlbmd0aCBiYXNlZCBvbiBzZWN1cml0eSBjb25maWd1cmF0aW9uXG4gKi9cbmV4cG9ydCBjb25zdCB2YWxpZGF0ZVBhc3N3b3JkID0gKHBhc3N3b3JkOiBzdHJpbmcpOiB7IGlzVmFsaWQ6IGJvb2xlYW47IGVycm9yczogc3RyaW5nW10gfSA9PiB7XG4gIGNvbnN0IGNvbmZpZyA9IHNlY3VyaXR5Q29uZmlnLmF1dGg7XG4gIGNvbnN0IGVycm9yczogc3RyaW5nW10gPSBbXTtcblxuICBpZiAocGFzc3dvcmQubGVuZ3RoIDwgY29uZmlnLnBhc3N3b3JkTWluTGVuZ3RoKSB7XG4gICAgZXJyb3JzLnB1c2goYFBhc3N3b3JkIG11c3QgYmUgYXQgbGVhc3QgJHtjb25maWcucGFzc3dvcmRNaW5MZW5ndGh9IGNoYXJhY3RlcnMgbG9uZ2ApO1xuICB9XG5cbiAgaWYgKGNvbmZpZy5wYXNzd29yZFJlcXVpcmVTcGVjaWFsQ2hhcnMgJiYgIS9bIUAjJCVeJiooKSwuP1wiOnt9fDw+XS8udGVzdChwYXNzd29yZCkpIHtcbiAgICBlcnJvcnMucHVzaCgnUGFzc3dvcmQgbXVzdCBjb250YWluIGF0IGxlYXN0IG9uZSBzcGVjaWFsIGNoYXJhY3RlcicpO1xuICB9XG5cbiAgaWYgKGNvbmZpZy5wYXNzd29yZFJlcXVpcmVOdW1iZXJzICYmICEvXFxkLy50ZXN0KHBhc3N3b3JkKSkge1xuICAgIGVycm9ycy5wdXNoKCdQYXNzd29yZCBtdXN0IGNvbnRhaW4gYXQgbGVhc3Qgb25lIG51bWJlcicpO1xuICB9XG5cbiAgaWYgKGNvbmZpZy5wYXNzd29yZFJlcXVpcmVVcHBlcmNhc2UgJiYgIS9bQS1aXS8udGVzdChwYXNzd29yZCkpIHtcbiAgICBlcnJvcnMucHVzaCgnUGFzc3dvcmQgbXVzdCBjb250YWluIGF0IGxlYXN0IG9uZSB1cHBlcmNhc2UgbGV0dGVyJyk7XG4gIH1cblxuICByZXR1cm4ge1xuICAgIGlzVmFsaWQ6IGVycm9ycy5sZW5ndGggPT09IDAsXG4gICAgZXJyb3JzLFxuICB9O1xufTtcblxuLyoqXG4gKiBHZW5lcmF0ZSBzZWN1cmUgcmFuZG9tIHN0cmluZyBmb3IgdG9rZW5zXG4gKi9cbmV4cG9ydCBjb25zdCBnZW5lcmF0ZVNlY3VyZVRva2VuID0gKGxlbmd0aDogbnVtYmVyID0gMzIpOiBzdHJpbmcgPT4ge1xuICBjb25zdCBjaGFycyA9ICdBQkNERUZHSElKS0xNTk9QUVJTVFVWV1hZWmFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6MDEyMzQ1Njc4OSc7XG4gIGxldCByZXN1bHQgPSAnJztcbiAgY29uc3QgYXJyYXkgPSBuZXcgVWludDhBcnJheShsZW5ndGgpO1xuICBjcnlwdG8uZ2V0UmFuZG9tVmFsdWVzKGFycmF5KTtcblxuICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7XG4gICAgcmVzdWx0ICs9IGNoYXJzWyhhcnJheVtpXSB8fCAwKSAlIGNoYXJzLmxlbmd0aF07XG4gIH1cblxuICByZXR1cm4gcmVzdWx0O1xufTtcblxuLyoqXG4gKiBDaGVjayBpZiByZXF1ZXN0IG9yaWdpbiBpcyBhbGxvd2VkXG4gKi9cbmV4cG9ydCBjb25zdCBpc09yaWdpbkFsbG93ZWQgPSAob3JpZ2luOiBzdHJpbmcpOiBib29sZWFuID0+IHtcbiAgY29uc3QgY29uZmlnID0gc2VjdXJpdHlDb25maWcuY29ycztcbiAgY29uc3QgYWxsb3dlZE9yaWdpbnMgPSBBcnJheS5pc0FycmF5KGNvbmZpZy5vcmlnaW4pID8gY29uZmlnLm9yaWdpbiA6IFtjb25maWcub3JpZ2luXTtcbiAgcmV0dXJuIGFsbG93ZWRPcmlnaW5zLmluY2x1ZGVzKG9yaWdpbik7XG59O1xuIl0sInZlcnNpb24iOjN9