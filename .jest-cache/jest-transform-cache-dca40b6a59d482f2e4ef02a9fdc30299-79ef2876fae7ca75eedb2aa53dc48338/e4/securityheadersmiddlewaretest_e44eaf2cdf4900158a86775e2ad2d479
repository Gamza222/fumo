a8a0cd205509145798e6294f76f07dbf
"use strict";
/**
 * Security Headers Middleware Tests
 */
Object.defineProperty(exports, "__esModule", { value: true });
// Import Next.js server mocks from factory
var nextjs_1 = require("@/shared/testing/mocks/nextjs");
// import { NextRequest } from 'next/server';
var security_headers_middleware_1 = require("./security-headers.middleware");
describe('Security Headers Middleware', function () {
    beforeEach(function () {
        jest.clearAllMocks();
    });
    describe('applySecurityHeaders', function () {
        it('should apply security headers to response', function () {
            var mockResponse = {
                headers: {
                    set: jest.fn(),
                },
            };
            (0, security_headers_middleware_1.applySecurityHeaders)(mockResponse);
            expect(mockResponse.headers.set).toHaveBeenCalledWith('Content-Security-Policy', expect.any(String));
            expect(mockResponse.headers.set).toHaveBeenCalledWith('X-Frame-Options', 'DENY');
            expect(mockResponse.headers.set).toHaveBeenCalledWith('X-Content-Type-Options', 'nosniff');
        });
    });
    describe('generateNonce', function () {
        it('should generate a nonce string', function () {
            var nonce = (0, security_headers_middleware_1.generateNonce)();
            expect(nonce).toMatch(/^[0-9a-f]{32}$/);
        });
        it('should generate different nonces', function () {
            var nonce1 = (0, security_headers_middleware_1.generateNonce)();
            var nonce2 = (0, security_headers_middleware_1.generateNonce)();
            expect(nonce1).not.toBe(nonce2);
        });
    });
    describe('updateCSPWithNonce', function () {
        it('should add nonce to CSP', function () {
            var nonce = 'test-nonce';
            var updatedCSP = (0, security_headers_middleware_1.updateCSPWithNonce)(nonce);
            expect(updatedCSP).toContain("'nonce-".concat(nonce, "'"));
        });
    });
    describe('reportCSPViolation', function () {
        it('should log CSP violation', function () {
            var consoleSpy = jest.spyOn(console, 'error').mockImplementation();
            var consoleLogSpy = jest.spyOn(console, 'log').mockImplementation();
            var violation = {
                blockedURI: 'http://example.com/script.js',
                documentURI: 'http://localhost:3000/',
                violatedDirective: 'script-src',
                effectiveDirective: 'script-src',
                originalPolicy: "script-src 'self'",
                referrer: 'http://localhost:3000/',
            };
            (0, security_headers_middleware_1.reportCSPViolation)(violation);
            expect(consoleSpy).toHaveBeenCalledWith('CSP Violation:', violation);
            expect(consoleLogSpy).toHaveBeenCalledWith('CSP Violation Report:', expect.any(Object));
            consoleSpy.mockRestore();
            consoleLogSpy.mockRestore();
        });
    });
    describe('isSuspiciousRequest', function () {
        it('should detect suspicious user agents', function () {
            var request = new nextjs_1.MockNextRequest('http://localhost:3000/', {
                headers: {
                    'user-agent': 'sqlmap/1.0',
                },
            });
            expect((0, security_headers_middleware_1.isSuspiciousRequest)(request)).toBe(true);
        });
        it('should detect suspicious origins', function () {
            var request = new nextjs_1.MockNextRequest('http://localhost:3000/', {
                headers: {
                    origin: 'http://localhost:8080',
                },
            });
            expect((0, security_headers_middleware_1.isSuspiciousRequest)(request)).toBe(true);
        });
        it('should allow normal requests', function () {
            var request = new nextjs_1.MockNextRequest('http://localhost:3000/', {
                headers: {
                    'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
                    origin: 'http://localhost:3000',
                },
            });
            expect((0, security_headers_middleware_1.isSuspiciousRequest)(request)).toBe(false);
        });
    });
    describe('securityMiddleware', function () {
        it('should block suspicious requests', function () {
            var request = new nextjs_1.MockNextRequest('http://localhost:3000/', {
                headers: {
                    'user-agent': 'sqlmap/1.0',
                },
            });
            var response = (0, security_headers_middleware_1.securityMiddleware)(request);
            expect(response.status).toBe(403);
        });
        it('should allow normal requests', function () {
            var request = new nextjs_1.MockNextRequest('http://localhost:3000/', {
                headers: {
                    'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
                },
            });
            var response = (0, security_headers_middleware_1.securityMiddleware)(request);
            expect(response.status).toBe(200);
        });
    });
    describe('corsMiddleware', function () {
        it('should handle preflight requests', function () {
            var request = new nextjs_1.MockNextRequest('http://localhost:3000/api/test', {
                method: 'OPTIONS',
                headers: {
                    origin: 'http://localhost:3000',
                    'access-control-request-method': 'POST',
                    'access-control-request-headers': 'Content-Type',
                },
            });
            var response = (0, security_headers_middleware_1.corsMiddleware)(request);
            expect(response.status).toBe(200);
        });
        it('should handle actual requests', function () {
            var request = new nextjs_1.MockNextRequest('http://localhost:3000/api/test', {
                method: 'POST',
                headers: {
                    origin: 'http://localhost:3000',
                },
            });
            var response = (0, security_headers_middleware_1.corsMiddleware)(request);
            expect(response.status).toBe(200);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2dhbXphcmFtYXphbm92L0Rlc2t0b3AvZnVtby9zcmMvaW5mcmFzdHJ1Y3R1cmUvc2VjdXJpdHkvbGliL3NlY3VyaXR5LWhlYWRlcnMvc2VjdXJpdHktaGVhZGVycy5taWRkbGV3YXJlLnRlc3QudHMiLCJtYXBwaW5ncyI6IjtBQUFBOztHQUVHOztBQUVILDJDQUEyQztBQUMzQyx3REFBZ0U7QUFFaEUsNkNBQTZDO0FBQzdDLDZFQVF1QztBQUV2QyxRQUFRLENBQUMsNkJBQTZCLEVBQUU7SUFDdEMsVUFBVSxDQUFDO1FBQ1QsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQ3ZCLENBQUMsQ0FBQyxDQUFDO0lBRUgsUUFBUSxDQUFDLHNCQUFzQixFQUFFO1FBQy9CLEVBQUUsQ0FBQywyQ0FBMkMsRUFBRTtZQUM5QyxJQUFNLFlBQVksR0FBRztnQkFDbkIsT0FBTyxFQUFFO29CQUNQLEdBQUcsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO2lCQUNmO2FBQ0YsQ0FBQztZQUVGLElBQUEsa0RBQW9CLEVBQUMsWUFBbUIsQ0FBQyxDQUFDO1lBRTFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLG9CQUFvQixDQUNuRCx5QkFBeUIsRUFDekIsTUFBTSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FDbkIsQ0FBQztZQUNGLE1BQU0sQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLG9CQUFvQixDQUFDLGlCQUFpQixFQUFFLE1BQU0sQ0FBQyxDQUFDO1lBQ2pGLE1BQU0sQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLG9CQUFvQixDQUFDLHdCQUF3QixFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBQzdGLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsZUFBZSxFQUFFO1FBQ3hCLEVBQUUsQ0FBQyxnQ0FBZ0MsRUFBRTtZQUNuQyxJQUFNLEtBQUssR0FBRyxJQUFB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QyxJQUFNLE9BQU8sR0FBRyxJQUFJLHdCQUFlLENBQUMsZ0NBQWdDLEVBQUU7Z0JBQ3BFLE1BQU0sRUFBRSxTQUFTO2dCQUNqQixPQUFPLEVBQUU7b0JBQ1AsTUFBTSxFQUFFLHVCQUF1QjtvQkFDL0IsK0JBQStCLEVBQUUsTUFBTTtvQkFDdkMsZ0NBQWdDLEVBQUUsY0FBYztpQkFDakQ7YUFDRixDQUFDLENBQUM7WUFFSCxJQUFNLFFBQVEsR0FBRyxJQUFBLDRDQUFjLEVBQUMsT0FBYyxDQUFDLENBQUM7WUFDaEQsTUFBTSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDcEMsQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsK0JBQStCLEVBQUU7WUFDbEMsSUFBTSxPQUFPLEdBQUcsSUFBSSx3QkFBZSxDQUFDLGdDQUFnQyxFQUFFO2dCQUNwRSxNQUFNLEVBQUUsTUFBTTtnQkFDZCxPQUFPLEVBQUU7b0JBQ1AsTUFBTSxFQUFFLHVCQUF1QjtpQkFDaEM7YUFDRixDQUFDLENBQUM7WUFFSCxJQUFNLFFBQVEsR0FBRyxJQUFBLDRDQUFjLEVBQUMsT0FBYyxDQUFDLENBQUM7WUFDaEQsTUFBTSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDcEMsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9nYW16YXJhbWF6YW5vdi9EZXNrdG9wL2Z1bW8vc3JjL2luZnJhc3RydWN0dXJlL3NlY3VyaXR5L2xpYi9zZWN1cml0eS1oZWFkZXJzL3NlY3VyaXR5LWhlYWRlcnMubWlkZGxld2FyZS50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogU2VjdXJpdHkgSGVhZGVycyBNaWRkbGV3YXJlIFRlc3RzXG4gKi9cblxuLy8gSW1wb3J0IE5leHQuanMgc2VydmVyIG1vY2tzIGZyb20gZmFjdG9yeVxuaW1wb3J0IHsgTW9ja05leHRSZXF1ZXN0IH0gZnJvbSAnQC9zaGFyZWQvdGVzdGluZy9tb2Nrcy9uZXh0anMnO1xuXG4vLyBpbXBvcnQgeyBOZXh0UmVxdWVzdCB9IGZyb20gJ25leHQvc2VydmVyJztcbmltcG9ydCB7XG4gIGFwcGx5U2VjdXJpdHlIZWFkZXJzLFxuICBjb3JzTWlkZGxld2FyZSxcbiAgZ2VuZXJhdGVOb25jZSxcbiAgaXNTdXNwaWNpb3VzUmVxdWVzdCxcbiAgcmVwb3J0Q1NQVmlvbGF0aW9uLFxuICBzZWN1cml0eU1pZGRsZXdhcmUsXG4gIHVwZGF0ZUNTUFdpdGhOb25jZSxcbn0gZnJvbSAnLi9zZWN1cml0eS1oZWFkZXJzLm1pZGRsZXdhcmUnO1xuXG5kZXNjcmliZSgnU2VjdXJpdHkgSGVhZGVycyBNaWRkbGV3YXJlJywgKCkgPT4ge1xuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICBqZXN0LmNsZWFyQWxsTW9ja3MoKTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2FwcGx5U2VjdXJpdHlIZWFkZXJzJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgYXBwbHkgc2VjdXJpdHkgaGVhZGVycyB0byByZXNwb25zZScsICgpID0+IHtcbiAgICAgIGNvbnN0IG1vY2tSZXNwb25zZSA9IHtcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgIHNldDogamVzdC5mbigpLFxuICAgICAgICB9LFxuICAgICAgfTtcblxuICAgICAgYXBwbHlTZWN1cml0eUhlYWRlcnMobW9ja1Jlc3BvbnNlIGFzIGFueSk7XG5cbiAgICAgIGV4cGVjdChtb2NrUmVzcG9uc2UuaGVhZGVycy5zZXQpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICAnQ29udGVudC1TZWN1cml0eS1Qb2xpY3knLFxuICAgICAgICBleHBlY3QuYW55KFN0cmluZylcbiAgICAgICk7XG4gICAgICBleHBlY3QobW9ja1Jlc3BvbnNlLmhlYWRlcnMuc2V0KS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgnWC1GcmFtZS1PcHRpb25zJywgJ0RFTlknKTtcbiAgICAgIGV4cGVjdChtb2NrUmVzcG9uc2UuaGVhZGVycy5zZXQpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCdYLUNvbnRlbnQtVHlwZS1PcHRpb25zJywgJ25vc25pZmYnKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2dlbmVyYXRlTm9uY2UnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBnZW5lcmF0ZSBhIG5vbmNlIHN0cmluZycsICgpID0+IHtcbiAgICAgIGNvbnN0IG5vbmNlID0gZ2VuZXJhdGVOb25jZSgpO1xuICAgICAgZXhwZWN0KG5vbmNlKS50b01hdGNoKC9eWzAtOWEtZl17MzJ9JC8pO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBnZW5lcmF0ZSBkaWZmZXJlbnQgbm9uY2VzJywgKCkgPT4ge1xuICAgICAgY29uc3Qgbm9uY2UxID0gZ2VuZXJhdGVOb25jZSgpO1xuICAgICAgY29uc3Qgbm9uY2UyID0gZ2VuZXJhdGVOb25jZSgpO1xuICAgICAgZXhwZWN0KG5vbmNlMSkubm90LnRvQmUobm9uY2UyKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ3VwZGF0ZUNTUFdpdGhOb25jZScsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGFkZCBub25jZSB0byBDU1AnLCAoKSA9PiB7XG4gICAgICBjb25zdCBub25jZSA9ICd0ZXN0LW5vbmNlJztcbiAgICAgIGNvbnN0IHVwZGF0ZWRDU1AgPSB1cGRhdGVDU1BXaXRoTm9uY2Uobm9uY2UpO1xuXG4gICAgICBleHBlY3QodXBkYXRlZENTUCkudG9Db250YWluKGAnbm9uY2UtJHtub25jZX0nYCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdyZXBvcnRDU1BWaW9sYXRpb24nLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBsb2cgQ1NQIHZpb2xhdGlvbicsICgpID0+IHtcbiAgICAgIGNvbnN0IGNvbnNvbGVTcHkgPSBqZXN0LnNweU9uKGNvbnNvbGUsICdlcnJvcicpLm1vY2tJbXBsZW1lbnRhdGlvbigpO1xuICAgICAgY29uc3QgY29uc29sZUxvZ1NweSA9IGplc3Quc3B5T24oY29uc29sZSwgJ2xvZycpLm1vY2tJbXBsZW1lbnRhdGlvbigpO1xuXG4gICAgICBjb25zdCB2aW9sYXRpb24gPSB7XG4gICAgICAgIGJsb2NrZWRVUkk6ICdodHRwOi8vZXhhbXBsZS5jb20vc2NyaXB0LmpzJyxcbiAgICAgICAgZG9jdW1lbnRVUkk6ICdodHRwOi8vbG9jYWxob3N0OjMwMDAvJyxcbiAgICAgICAgdmlvbGF0ZWREaXJlY3RpdmU6ICdzY3JpcHQtc3JjJyxcbiAgICAgICAgZWZmZWN0aXZlRGlyZWN0aXZlOiAnc2NyaXB0LXNyYycsXG4gICAgICAgIG9yaWdpbmFsUG9saWN5OiBcInNjcmlwdC1zcmMgJ3NlbGYnXCIsXG4gICAgICAgIHJlZmVycmVyOiAnaHR0cDovL2xvY2FsaG9zdDozMDAwLycsXG4gICAgICB9O1xuXG4gICAgICByZXBvcnRDU1BWaW9sYXRpb24odmlvbGF0aW9uKTtcblxuICAgICAgZXhwZWN0KGNvbnNvbGVTcHkpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCdDU1AgVmlvbGF0aW9uOicsIHZpb2xhdGlvbik7XG4gICAgICBleHBlY3QoY29uc29sZUxvZ1NweSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ0NTUCBWaW9sYXRpb24gUmVwb3J0OicsIGV4cGVjdC5hbnkoT2JqZWN0KSk7XG5cbiAgICAgIGNvbnNvbGVTcHkubW9ja1Jlc3RvcmUoKTtcbiAgICAgIGNvbnNvbGVMb2dTcHkubW9ja1Jlc3RvcmUoKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2lzU3VzcGljaW91c1JlcXVlc3QnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBkZXRlY3Qgc3VzcGljaW91cyB1c2VyIGFnZW50cycsICgpID0+IHtcbiAgICAgIGNvbnN0IHJlcXVlc3QgPSBuZXcgTW9ja05leHRSZXF1ZXN0KCdodHRwOi8vbG9jYWxob3N0OjMwMDAvJywge1xuICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgJ3VzZXItYWdlbnQnOiAnc3FsbWFwLzEuMCcsXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgZXhwZWN0KGlzU3VzcGljaW91c1JlcXVlc3QocmVxdWVzdCBhcyBhbnkpKS50b0JlKHRydWUpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBkZXRlY3Qgc3VzcGljaW91cyBvcmlnaW5zJywgKCkgPT4ge1xuICAgICAgY29uc3QgcmVxdWVzdCA9IG5ldyBNb2NrTmV4dFJlcXVlc3QoJ2h0dHA6Ly9sb2NhbGhvc3Q6MzAwMC8nLCB7XG4gICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICBvcmlnaW46ICdodHRwOi8vbG9jYWxob3N0OjgwODAnLFxuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIGV4cGVjdChpc1N1c3BpY2lvdXNSZXF1ZXN0KHJlcXVlc3QgYXMgYW55KSkudG9CZSh0cnVlKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgYWxsb3cgbm9ybWFsIHJlcXVlc3RzJywgKCkgPT4ge1xuICAgICAgY29uc3QgcmVxdWVzdCA9IG5ldyBNb2NrTmV4dFJlcXVlc3QoJ2h0dHA6Ly9sb2NhbGhvc3Q6MzAwMC8nLCB7XG4gICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAndXNlci1hZ2VudCc6ICdNb3ppbGxhLzUuMCAoV2luZG93cyBOVCAxMC4wOyBXaW42NDsgeDY0KSBBcHBsZVdlYktpdC81MzcuMzYnLFxuICAgICAgICAgIG9yaWdpbjogJ2h0dHA6Ly9sb2NhbGhvc3Q6MzAwMCcsXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgZXhwZWN0KGlzU3VzcGljaW91c1JlcXVlc3QocmVxdWVzdCBhcyBhbnkpKS50b0JlKGZhbHNlKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ3NlY3VyaXR5TWlkZGxld2FyZScsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGJsb2NrIHN1c3BpY2lvdXMgcmVxdWVzdHMnLCAoKSA9PiB7XG4gICAgICBjb25zdCByZXF1ZXN0ID0gbmV3IE1vY2tOZXh0UmVxdWVzdCgnaHR0cDovL2xvY2FsaG9zdDozMDAwLycsIHtcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICd1c2VyLWFnZW50JzogJ3NxbG1hcC8xLjAnLFxuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gc2VjdXJpdHlNaWRkbGV3YXJlKHJlcXVlc3QgYXMgYW55KTtcbiAgICAgIGV4cGVjdChyZXNwb25zZS5zdGF0dXMpLnRvQmUoNDAzKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgYWxsb3cgbm9ybWFsIHJlcXVlc3RzJywgKCkgPT4ge1xuICAgICAgY29uc3QgcmVxdWVzdCA9IG5ldyBNb2NrTmV4dFJlcXVlc3QoJ2h0dHA6Ly9sb2NhbGhvc3Q6MzAwMC8nLCB7XG4gICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAndXNlci1hZ2VudCc6ICdNb3ppbGxhLzUuMCAoV2luZG93cyBOVCAxMC4wOyBXaW42NDsgeDY0KSBBcHBsZVdlYktpdC81MzcuMzYnLFxuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gc2VjdXJpdHlNaWRkbGV3YXJlKHJlcXVlc3QgYXMgYW55KTtcbiAgICAgIGV4cGVjdChyZXNwb25zZS5zdGF0dXMpLnRvQmUoMjAwKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2NvcnNNaWRkbGV3YXJlJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgaGFuZGxlIHByZWZsaWdodCByZXF1ZXN0cycsICgpID0+IHtcbiAgICAgIGNvbnN0IHJlcXVlc3QgPSBuZXcgTW9ja05leHRSZXF1ZXN0KCdodHRwOi8vbG9jYWxob3N0OjMwMDAvYXBpL3Rlc3QnLCB7XG4gICAgICAgIG1ldGhvZDogJ09QVElPTlMnLFxuICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgb3JpZ2luOiAnaHR0cDovL2xvY2FsaG9zdDozMDAwJyxcbiAgICAgICAgICAnYWNjZXNzLWNvbnRyb2wtcmVxdWVzdC1tZXRob2QnOiAnUE9TVCcsXG4gICAgICAgICAgJ2FjY2Vzcy1jb250cm9sLXJlcXVlc3QtaGVhZGVycyc6ICdDb250ZW50LVR5cGUnLFxuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gY29yc01pZGRsZXdhcmUocmVxdWVzdCBhcyBhbnkpO1xuICAgICAgZXhwZWN0KHJlc3BvbnNlLnN0YXR1cykudG9CZSgyMDApO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgYWN0dWFsIHJlcXVlc3RzJywgKCkgPT4ge1xuICAgICAgY29uc3QgcmVxdWVzdCA9IG5ldyBNb2NrTmV4dFJlcXVlc3QoJ2h0dHA6Ly9sb2NhbGhvc3Q6MzAwMC9hcGkvdGVzdCcsIHtcbiAgICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICBvcmlnaW46ICdodHRwOi8vbG9jYWxob3N0OjMwMDAnLFxuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gY29yc01pZGRsZXdhcmUocmVxdWVzdCBhcyBhbnkpO1xuICAgICAgZXhwZWN0KHJlc3BvbnNlLnN0YXR1cykudG9CZSgyMDApO1xuICAgIH0pO1xuICB9KTtcbn0pO1xuIl0sInZlcnNpb24iOjN9