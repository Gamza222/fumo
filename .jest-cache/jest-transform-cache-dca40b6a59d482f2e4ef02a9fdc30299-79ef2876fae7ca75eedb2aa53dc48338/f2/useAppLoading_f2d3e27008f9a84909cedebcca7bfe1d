646fbdefb8b517d6d2bfbae98fc698b1
"use strict";
/**
 * useAppLoading Hook
 *
 * Manages initial app loading state and progress.
 * Checks multiple conditions sequentially with minimum display time.
 * Provides smooth loading experience with progress tracking.
 */
"use client";
/**
 * useAppLoading Hook
 *
 * Manages initial app loading state and progress.
 * Checks multiple conditions sequentially with minimum display time.
 * Provides smooth loading experience with progress tracking.
 */
var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (this && this.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g = Object.create((typeof Iterator === "function" ? Iterator : Object).prototype);
    return g.next = verb(0), g["throw"] = verb(1), g["return"] = verb(2), typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (g && (g = 0, op[0] && (_ = 0)), _) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.useAppLoading = useAppLoading;
var react_1 = require("react");
var enums_1 = require("../../model/enums/enums");
var constants_1 = require("../../model/constants/constants");
// ============================================================================
// CONDITION CHECKS (Single Responsibility - Each checks one thing)
// ============================================================================
var checkDOMReady = function () { return document.readyState === constants_1.DOCUMENT_COMPLETE; };
var checkCriticalCSS = function () {
    var criticalSheets = document.querySelectorAll(constants_1.SELECTORS.CRITICAL_CSS);
    return (criticalSheets.length === 0 ||
        Array.from(criticalSheets).every(function (sheet) { return sheet.sheet !== null; }));
};
var checkThemeInitialized = function () {
    return (document.documentElement.hasAttribute(constants_1.SELECTORS.THEME_ATTRIBUTE) ||
        document.body.classList.contains(constants_1.SELECTORS.THEME_CLASS) ||
        document.documentElement.classList.contains(constants_1.SELECTORS.THEME_APPLIED_CLASS));
};
var checkCoreJavaScript = function () {
    return (typeof window !== "undefined" && document.readyState === constants_1.DOCUMENT_COMPLETE);
};
var ensureMinimumDisplayTime = function () { return __awaiter(void 0, void 0, Promise, function () {
    var startTime, elapsedTime, remainingTime;
    return __generator(this, function (_a) {
        switch (_a.label) {
            case 0:
                startTime = performance.now();
                elapsedTime = performance.now() - startTime;
                remainingTime = Math.max(0, constants_1.MINIMUM_DISPLAY_TIME - elapsedTime);
                if (!(remainingTime > 0)) return [3 /*break*/, 2];
                return [4 /*yield*/, new Promise(function (resolve) { return setTimeout(resolve, remainingTime); })];
            case 1:
                _a.sent();
                _a.label = 2;
            case 2: return [2 /*return*/];
        }
    });
}); };
// ============================================================================
// CONDITIONS CONFIGURATION (Open/Closed - Easy to extend)
// ============================================================================
var createLoadingConditions = function () { return [
    {
        id: enums_1.AppLoadingConditionId.DOM_READY,
        name: enums_1.AppLoadingConditionName.PREPARING_APPLICATION,
        priority: constants_1.PRIORITIES[enums_1.AppLoadingConditionId.DOM_READY],
        check: checkDOMReady,
        timeout: constants_1.TIMEOUTS[enums_1.AppLoadingConditionId.DOM_READY],
    },
    {
        id: enums_1.AppLoadingConditionId.CRITICAL_CSS,
        name: enums_1.AppLoadingConditionName.LOADING_STYLES,
        priority: constants_1.PRIORITIES[enums_1.AppLoadingConditionId.CRITICAL_CSS],
        check: checkCriticalCSS,
        timeout: constants_1.TIMEOUTS[enums_1.AppLoadingConditionId.CRITICAL_CSS],
    },
    {
        id: enums_1.AppLoadingConditionId.THEME_INITIALIZED,
        name: enums_1.AppLoadingConditionName.APPLYING_THEME,
        priority: constants_1.PRIORITIES[enums_1.AppLoadingConditionId.THEME_INITIALIZED],
        check: checkThemeInitialized,
        timeout: constants_1.TIMEOUTS[enums_1.AppLoadingConditionId.THEME_INITIALIZED],
    },
    {
        id: enums_1.AppLoadingConditionId.CORE_JAVASCRIPT,
        name: enums_1.AppLoadingConditionName.LOADING_CORE_FEATURES,
        priority: constants_1.PRIORITIES[enums_1.AppLoadingConditionId.CORE_JAVASCRIPT],
        check: checkCoreJavaScript,
        timeout: constants_1.TIMEOUTS[enums_1.AppLoadingConditionId.CORE_JAVASCRIPT],
    },
]; };
// ============================================================================
// MAIN HOOK (Orchestrates everything)
// ============================================================================
function useAppLoading() {
    var _this = this;
    var _a = (0, react_1.useState)({
        isInitialLoading: true,
        progress: 0,
        currentStep: "",
        steps: [],
        isSuspenseLoading: false,
    }), state = _a[0], setState = _a[1];
    var loadingConditions = (0, react_1.useMemo)(function () { return createLoadingConditions(); }, []);
    var checkLoadingSteps = (0, react_1.useCallback)(function () { return __awaiter(_this, void 0, void 0, function () {
        var stepsWithStatus, startTime, totalExpectedTime, animationFrameId, updateProgress, _loop_1, index;
        return __generator(this, function (_a) {
            switch (_a.label) {
                case 0:
                    stepsWithStatus = loadingConditions.map(function (condition) { return ({
                        id: condition.id,
                        name: condition.name,
                        completed: false,
                        priority: condition.priority || enums_1.AppLoadingPriority.LOWEST,
                    }); });
                    setState(function (prev) { return (__assign(__assign({}, prev), { steps: stepsWithStatus })); });
                    startTime = performance.now();
                    totalExpectedTime = loadingConditions.length * constants_1.MINIMUM_DISPLAY_TIME;
                    updateProgress = function () {
                        var elapsed = performance.now() - startTime;
                        var smoothProgress = Math.min((elapsed / totalExpectedTime) * 100, 100);
                        setState(function (prev) { return (__assign(__assign({}, prev), { progress: smoothProgress })); });
                        if (smoothProgress < 100) {
                            animationFrameId = requestAnimationFrame(updateProgress);
                        }
                    };
                    // Start the animation
                    animationFrameId = requestAnimationFrame(updateProgress);
                    _loop_1 = function (index) {
                        var condition, result_1, error_1;
                        return __generator(this, function (_b) {
                            switch (_b.label) {
                                case 0:
                                    condition = loadingConditions[index];
                                    // Update current step
                                    setState(function (prev) { return (__assign(__assign({}, prev), { currentStep: condition.name })); });
                                    _b.label = 1;
                                case 1:
                                    _b.trys.push([1, 4, , 6]);
                                    return [4 /*yield*/, Promise.race([
                                            Promise.resolve(condition.check()),
                                            new Promise(function (_, reject) {
                                                return setTimeout(function () { return reject(new Error("Timeout")); }, condition.timeout || constants_1.DEFAULT_TIMEOUT);
                                            }),
                                        ])];
                                case 2:
                                    result_1 = _b.sent();
                                    return [4 /*yield*/, ensureMinimumDisplayTime()];
                                case 3:
                                    _b.sent();
                                    setState(function (prev) { return (__assign(__assign({}, prev), { steps: prev.steps.map(function (step) {
                                            return step.id === condition.id ? __assign(__assign({}, step), { completed: result_1 }) : step;
                                        }) })); });
                                    return [3 /*break*/, 6];
                                case 4:
                                    error_1 = _b.sent();
                                    return [4 /*yield*/, ensureMinimumDisplayTime()];
                                case 5:
                                    _b.sent();
                                    setState(function (prev) { return (__assign(__assign({}, prev), { steps: prev.steps.map(function (step) {
                                            return step.id === condition.id ? __assign(__assign({}, step), { completed: true }) : step;
                                        }) })); });
                                    return [3 /*break*/, 6];
                                case 6: return [2 /*return*/];
                            }
                        });
                    };
                    index = 0;
                    _a.label = 1;
                case 1:
                    if (!(index < loadingConditions.length)) return [3 /*break*/, 4];
                    return [5 /*yield**/, _loop_1(index)];
                case 2:
                    _a.sent();
                    _a.label = 3;
                case 3:
                    index++;
                    return [3 /*break*/, 1];
                case 4:
                    // Clean up animation frame and complete
                    if (animationFrameId) {
                        cancelAnimationFrame(animationFrameId);
                    }
                    setState(function (prev) { return (__assign(__assign({}, prev), { isInitialLoading: false, progress: 100, currentStep: "Ready" })); });
                    return [2 /*return*/];
            }
        });
    }); }, [loadingConditions]);
    (0, react_1.useEffect)(function () {
        checkLoadingSteps();
    }, [checkLoadingSteps]);
    var forceComplete = (0, react_1.useCallback)(function () {
        setState(function (prev) { return (__assign(__assign({}, prev), { isInitialLoading: false, progress: 100, currentStep: "Ready" })); });
    }, []);
    var restart = (0, react_1.useCallback)(function () {
        setState({
            isInitialLoading: true,
            progress: 0,
            currentStep: "",
            steps: [],
            isSuspenseLoading: false,
        });
        checkLoadingSteps();
    }, [checkLoadingSteps]);
    var setSuspenseLoading = (0, react_1.useCallback)(function (loading) {
        setState(function (prev) { return (__assign(__assign({}, prev), { isSuspenseLoading: loading })); });
    }, []);
    var isOverallLoading = state.isInitialLoading || state.isSuspenseLoading;
    return __assign(__assign({}, state), { isOverallLoading: isOverallLoading, forceComplete: forceComplete, restart: restart, setSuspenseLoading: setSuspenseLoading });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2dhbXphcmFtYXphbm92L0Rlc2t0b3AvZnVtby9zcmMvaW5mcmFzdHJ1Y3R1cmUvcHJvdmlkZXJzL2FwcC1sb2FkaW5nL2hvb2tzL3VzZUFwcExvYWRpbmcvdXNlQXBwTG9hZGluZy50cyIsIm1hcHBpbmdzIjoiO0FBQUE7Ozs7OztHQU1HO0FBRUgsWUFBWSxDQUFDO0FBUmI7Ozs7OztHQU1HOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBd0dILHNDQXFJQztBQXpPRCwrQkFBa0U7QUFDbEUsaURBSWlDO0FBQ2pDLDZEQVF5QztBQU96QywrRUFBK0U7QUFDL0UsbUVBQW1FO0FBQ25FLCtFQUErRTtBQUUvRSxJQUFNLGFBQWEsR0FBRyxjQUFlLE9BQUEsUUFBUSxDQUFDLFVBQVUsS0FBSyw2QkFBaUIsRUFBekMsQ0FBeUMsQ0FBQztBQUUvRSxJQUFNLGdCQUFnQixHQUFHO0lBQ3ZCLElBQU0sY0FBYyxHQUFHLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxxQkFBUyxDQUFDLFlBQVksQ0FBQyxDQUFDO0lBQ3pFLE9BQU8sQ0FDTCxjQUFjLENBQUMsTUFBTSxLQUFLLENBQUM7UUFDM0IsS0FBSyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQyxLQUFLLENBQzlCLFVBQUMsS0FBSyxJQUFLLE9BQUMsS0FBeUIsQ0FBQyxLQUFLLEtBQUssSUFBSSxFQUF6QyxDQUF5QyxDQUNyRCxDQUNGLENBQUM7QUFDSixDQUFDLENBQUM7QUFFRixJQUFNLHFCQUFxQixHQUFHO0lBQzVCLE9BQU8sQ0FDTCxRQUFRLENBQUMsZUFBZSxDQUFDLFlBQVksQ0FBQyxxQkFBUyxDQUFDLGVBQWUsQ0FBQztRQUNoRSxRQUFRLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMscUJBQVMsQ0FBQyxXQUFXLENBQUM7UUFDdkQsUUFBUSxDQUFDLGVBQWUsQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLHFCQUFTLENBQUMsbUJBQW1CLENBQUMsQ0FDM0Us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QUUsSUFBSTtZQUN0QixRQUFRLEVBQUUsQ0FBQztZQUNYLFdBQVcsRUFBRSxFQUFFO1lBQ2YsS0FBSyxFQUFFLEVBQUU7WUFDVCxpQkFBaUIsRUFBRSxLQUFLO1NBQ3pCLENBQUMsQ0FBQztRQUNILGlCQUFpQixFQUFFLENBQUM7SUFDdEIsQ0FBQyxFQUFFLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxDQUFDO0lBRXhCLElBQU0sa0JBQWtCLEdBQUcsSUFBQSxtQkFBVyxFQUFDLFVBQUMsT0FBZ0I7UUFDdEQsUUFBUSxDQUFDLFVBQUMsSUFBSSxJQUFLLE9BQUEsdUJBQU0sSUFBSSxLQUFFLGlCQUFpQixFQUFFLE9BQU8sSUFBRyxFQUF6QyxDQUF5QyxDQUFDLENBQUM7SUFDaEUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBRVAsSUFBTSxnQkFBZ0IsR0FBRyxLQUFLLENBQUMsZ0JBQWdCLElBQUksS0FBSyxDQUFDLGlCQUFpQixDQUFDO0lBRTNFLDZCQUNLLEtBQUssS0FDUixnQkFBZ0Isa0JBQUEsRUFDaEIsYUFBYSxlQUFBLEVBQ2IsT0FBTyxTQUFBLEVBQ1Asa0JBQWtCLG9CQUFBLElBQ2xCO0FBQ0osQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvZ2FtemFyYW1hemFub3YvRGVza3RvcC9mdW1vL3NyYy9pbmZyYXN0cnVjdHVyZS9wcm92aWRlcnMvYXBwLWxvYWRpbmcvaG9va3MvdXNlQXBwTG9hZGluZy91c2VBcHBMb2FkaW5nLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogdXNlQXBwTG9hZGluZyBIb29rXG4gKlxuICogTWFuYWdlcyBpbml0aWFsIGFwcCBsb2FkaW5nIHN0YXRlIGFuZCBwcm9ncmVzcy5cbiAqIENoZWNrcyBtdWx0aXBsZSBjb25kaXRpb25zIHNlcXVlbnRpYWxseSB3aXRoIG1pbmltdW0gZGlzcGxheSB0aW1lLlxuICogUHJvdmlkZXMgc21vb3RoIGxvYWRpbmcgZXhwZXJpZW5jZSB3aXRoIHByb2dyZXNzIHRyYWNraW5nLlxuICovXG5cblwidXNlIGNsaWVudFwiO1xuXG5pbXBvcnQgeyB1c2VTdGF0ZSwgdXNlRWZmZWN0LCB1c2VDYWxsYmFjaywgdXNlTWVtbyB9IGZyb20gXCJyZWFjdFwiO1xuaW1wb3J0IHtcbiAgQXBwTG9hZGluZ0NvbmRpdGlvbklkLFxuICBBcHBMb2FkaW5nQ29uZGl0aW9uTmFtZSxcbiAgQXBwTG9hZGluZ1ByaW9yaXR5LFxufSBmcm9tIFwiLi4vLi4vbW9kZWwvZW51bXMvZW51bXNcIjtcbmltcG9ydCB7XG4gIFRJTUVPVVRTLFxuICBQUklPUklUSUVTLFxuICBNSU5JTVVNX0RJU1BMQVlfVElNRSxcbiAgU0VMRUNUT1JTLFxuICBET0NVTUVOVF9DT01QTEVURSxcbiAgRkFERV9PVVRfREVMQVksXG4gIERFRkFVTFRfVElNRU9VVCxcbn0gZnJvbSBcIi4uLy4uL21vZGVsL2NvbnN0YW50cy9jb25zdGFudHNcIjtcbmltcG9ydCB7XG4gIExvYWRpbmdDb25kaXRpb24sXG4gIExvYWRpbmdTdGVwLFxuICBVc2VBcHBMb2FkaW5nUmV0dXJuLFxufSBmcm9tIFwiLi4vLi4vbW9kZWwvdHlwZXMvdHlwZXNcIjtcblxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuLy8gQ09ORElUSU9OIENIRUNLUyAoU2luZ2xlIFJlc3BvbnNpYmlsaXR5IC0gRWFjaCBjaGVja3Mgb25lIHRoaW5nKVxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG5jb25zdCBjaGVja0RPTVJlYWR5ID0gKCk6IGJvb2xlYW4gPT4gZG9jdW1lbnQucmVhZHlTdGF0ZSA9PT0gRE9DVU1FTlRfQ09NUExFVEU7XG5cbmNvbnN0IGNoZWNrQ3JpdGljYWxDU1MgPSAoKTogYm9vbGVhbiA9PiB7XG4gIGNvbnN0IGNyaXRpY2FsU2hlZXRzID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChTRUxFQ1RPUlMuQ1JJVElDQUxfQ1NTKTtcbiAgcmV0dXJuIChcbiAgICBjcml0aWNhbFNoZWV0cy5sZW5ndGggPT09IDAgfHxcbiAgICBBcnJheS5mcm9tKGNyaXRpY2FsU2hlZXRzKS5ldmVyeShcbiAgICAgIChzaGVldCkgPT4gKHNoZWV0IGFzIEhUTUxMaW5rRWxlbWVudCkuc2hlZXQgIT09IG51bGxcbiAgICApXG4gICk7XG59O1xuXG5jb25zdCBjaGVja1RoZW1lSW5pdGlhbGl6ZWQgPSAoKTogYm9vbGVhbiA9PiB7XG4gIHJldHVybiAoXG4gICAgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50Lmhhc0F0dHJpYnV0ZShTRUxFQ1RPUlMuVEhFTUVfQVRUUklCVVRFKSB8fFxuICAgIGRvY3VtZW50LmJvZHkuY2xhc3NMaXN0LmNvbnRhaW5zKFNFTEVDVE9SUy5USEVNRV9DTEFTUykgfHxcbiAgICBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2xhc3NMaXN0LmNvbnRhaW5zKFNFTEVDVE9SUy5USEVNRV9BUFBMSUVEX0NMQVNTKVxuICApO1xufTtcblxuY29uc3QgY2hlY2tDb3JlSmF2YVNjcmlwdCA9ICgpOiBib29sZWFuID0+IHtcbiAgcmV0dXJuIChcbiAgICB0eXBlb2Ygd2luZG93ICE9PSBcInVuZGVmaW5lZFwiICYmIGRvY3VtZW50LnJlYWR5U3RhdGUgPT09IERPQ1VNRU5UX0NPTVBMRVRFXG4gICk7XG59O1xuXG5jb25zdCBlbnN1cmVNaW5pbXVtRGlzcGxheVRpbWUgPSBhc3luYyAoKTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gIGNvbnN0IHN0YXJ0VGltZSA9IHBlcmZvcm1hbmNlLm5vdygpO1xuICBjb25zdCBlbGFwc2VkVGltZSA9IHBlcmZvcm1hbmNlLm5vdygpIC0gc3RhcnRUaW1lO1xuICBjb25zdCByZW1haW5pbmdUaW1lID0gTWF0aC5tYXgoMCwgTUlOSU1VTV9ESVNQTEFZX1RJTUUgLSBlbGFwc2VkVGltZSk7XG5cbiAgaWYgKHJlbWFpbmluZ1RpbWUgPiAwKSB7XG4gICAgYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgcmVtYWluaW5nVGltZSkpO1xuICB9XG59O1xuXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4vLyBDT05ESVRJT05TIENPTkZJR1VSQVRJT04gKE9wZW4vQ2xvc2VkIC0gRWFzeSB0byBleHRlbmQpXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbmNvbnN0IGNyZWF0ZUxvYWRpbmdDb25kaXRpb25zID0gKCk6IExvYWRpbmdDb25kaXRpb25bXSA9PiBbXG4gIHtcbiAgICBpZDogQXBwTG9hZGluZ0NvbmRpdGlvbklkLkRPTV9SRUFEWSxcbiAgICBuYW1lOiBBcHBMb2FkaW5nQ29uZGl0aW9uTmFtZS5QUkVQQVJJTkdfQVBQTElDQVRJT04sXG4gICAgcHJpb3JpdHk6IFBSSU9SSVRJRVNbQXBwTG9hZGluZ0NvbmRpdGlvbklkLkRPTV9SRUFEWV0sXG4gICAgY2hlY2s6IGNoZWNrRE9NUmVhZHksXG4gICAgdGltZW91dDogVElNRU9VVFNbQXBwTG9hZGluZ0NvbmRpdGlvbklkLkRPTV9SRUFEWV0sXG4gIH0sXG4gIHtcbiAgICBpZDogQXBwTG9hZGluZ0NvbmRpdGlvbklkLkNSSVRJQ0FMX0NTUyxcbiAgICBuYW1lOiBBcHBMb2FkaW5nQ29uZGl0aW9uTmFtZS5MT0FESU5HX1NUWUxFUyxcbiAgICBwcmlvcml0eTogUFJJT1JJVElFU1tBcHBMb2FkaW5nQ29uZGl0aW9uSWQuQ1JJVElDQUxfQ1NTXSxcbiAgICBjaGVjazogY2hlY2tDcml0aWNhbENTUyxcbiAgICB0aW1lb3V0OiBUSU1FT1VUU1tBcHBMb2FkaW5nQ29uZGl0aW9uSWQuQ1JJVElDQUxfQ1NTXSxcbiAgfSxcbiAge1xuICAgIGlkOiBBcHBMb2FkaW5nQ29uZGl0aW9uSWQuVEhFTUVfSU5JVElBTElaRUQsXG4gICAgbmFtZTogQXBwTG9hZGluZ0NvbmRpdGlvbk5hbWUuQVBQTFlJTkdfVEhFTUUsXG4gICAgcHJpb3JpdHk6IFBSSU9SSVRJRVNbQXBwTG9hZGluZ0NvbmRpdGlvbklkLlRIRU1FX0lOSVRJQUxJWkVEXSxcbiAgICBjaGVjazogY2hlY2tUaGVtZUluaXRpYWxpemVkLFxuICAgIHRpbWVvdXQ6IFRJTUVPVVRTW0FwcExvYWRpbmdDb25kaXRpb25JZC5USEVNRV9JTklUSUFMSVpFRF0sXG4gIH0sXG4gIHtcbiAgICBpZDogQXBwTG9hZGluZ0NvbmRpdGlvbklkLkNPUkVfSkFWQVNDUklQVCxcbiAgICBuYW1lOiBBcHBMb2FkaW5nQ29uZGl0aW9uTmFtZS5MT0FESU5HX0NPUkVfRkVBVFVSRVMsXG4gICAgcHJpb3JpdHk6IFBSSU9SSVRJRVNbQXBwTG9hZGluZ0NvbmRpdGlvbklkLkNPUkVfSkFWQVNDUklQVF0sXG4gICAgY2hlY2s6IGNoZWNrQ29yZUphdmFTY3JpcHQsXG4gICAgdGltZW91dDogVElNRU9VVFNbQXBwTG9hZGluZ0NvbmRpdGlvbklkLkNPUkVfSkFWQVNDUklQVF0sXG4gIH0sXG5dO1xuXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4vLyBNQUlOIEhPT0sgKE9yY2hlc3RyYXRlcyBldmVyeXRoaW5nKVxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG5leHBvcnQgZnVuY3Rpb24gdXNlQXBwTG9hZGluZygpOiBVc2VBcHBMb2FkaW5nUmV0dXJuIHtcbiAgY29uc3QgW3N0YXRlLCBzZXRTdGF0ZV0gPSB1c2VTdGF0ZSh7XG4gICAgaXNJbml0aWFsTG9hZGluZzogdHJ1ZSxcbiAgICBwcm9ncmVzczogMCxcbiAgICBjdXJyZW50U3RlcDogXCJcIixcbiAgICBzdGVwczogW10gYXMgTG9hZGluZ1N0ZXBbXSxcbiAgICBpc1N1c3BlbnNlTG9hZGluZzogZmFsc2UsXG4gIH0pO1xuXG4gIGNvbnN0IGxvYWRpbmdDb25kaXRpb25zID0gdXNlTWVtbygoKSA9PiBjcmVhdGVMb2FkaW5nQ29uZGl0aW9ucygpLCBbXSk7XG5cbiAgY29uc3QgY2hlY2tMb2FkaW5nU3RlcHMgPSB1c2VDYWxsYmFjayhhc3luYyAoKSA9PiB7XG4gICAgY29uc3Qgc3RlcHNXaXRoU3RhdHVzOiBMb2FkaW5nU3RlcFtdID0gbG9hZGluZ0NvbmRpdGlvbnMubWFwKFxuICAgICAgKGNvbmRpdGlvbikgPT4gKHtcbiAgICAgICAgaWQ6IGNvbmRpdGlvbi5pZCxcbiAgICAgICAgbmFtZTogY29uZGl0aW9uLm5hbWUsXG4gICAgICAgIGNvbXBsZXRlZDogZmFsc2UsXG4gICAgICAgIHByaW9yaXR5OiBjb25kaXRpb24ucHJpb3JpdHkgfHwgQXBwTG9hZGluZ1ByaW9yaXR5LkxPV0VTVCxcbiAgICAgIH0pXG4gICAgKTtcblxuICAgIHNldFN0YXRlKChwcmV2KSA9PiAoeyAuLi5wcmV2LCBzdGVwczogc3RlcHNXaXRoU3RhdHVzIH0pKTtcblxuICAgIC8vIFN0YXJ0IGNvbnRpbnVvdXMgcHJvZ3Jlc3MgdXBkYXRlcyB3aXRoIHJlcXVlc3RBbmltYXRpb25GcmFtZVxuICAgIGNvbnN0IHN0YXJ0VGltZSA9IHBlcmZvcm1hbmNlLm5vdygpO1xuICAgIGNvbnN0IHRvdGFsRXhwZWN0ZWRUaW1lID0gbG9hZGluZ0NvbmRpdGlvbnMubGVuZ3RoICogTUlOSU1VTV9ESVNQTEFZX1RJTUU7XG5cbiAgICBsZXQgYW5pbWF0aW9uRnJhbWVJZDogbnVtYmVyO1xuXG4gICAgY29uc3QgdXBkYXRlUHJvZ3Jlc3MgPSAoKSA9PiB7XG4gICAgICBjb25zdCBlbGFwc2VkID0gcGVyZm9ybWFuY2Uubm93KCkgLSBzdGFydFRpbWU7XG4gICAgICBjb25zdCBzbW9vdGhQcm9ncmVzcyA9IE1hdGgubWluKChlbGFwc2VkIC8gdG90YWxFeHBlY3RlZFRpbWUpICogMTAwLCAxMDApO1xuICAgICAgc2V0U3RhdGUoKHByZXYpID0+ICh7IC4uLnByZXYsIHByb2dyZXNzOiBzbW9vdGhQcm9ncmVzcyB9KSk7XG5cbiAgICAgIGlmIChzbW9vdGhQcm9ncmVzcyA8IDEwMCkge1xuICAgICAgICBhbmltYXRpb25GcmFtZUlkID0gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKHVwZGF0ZVByb2dyZXNzKTtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgLy8gU3RhcnQgdGhlIGFuaW1hdGlvblxuICAgIGFuaW1hdGlvbkZyYW1lSWQgPSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUodXBkYXRlUHJvZ3Jlc3MpO1xuXG4gICAgLy8gUHJvY2VzcyBjb25kaXRpb25zIHNlcXVlbnRpYWxseVxuICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCBsb2FkaW5nQ29uZGl0aW9ucy5sZW5ndGg7IGluZGV4KyspIHtcbiAgICAgIGNvbnN0IGNvbmRpdGlvbiA9IGxvYWRpbmdDb25kaXRpb25zW2luZGV4XSBhcyBMb2FkaW5nQ29uZGl0aW9uO1xuXG4gICAgICAvLyBVcGRhdGUgY3VycmVudCBzdGVwXG4gICAgICBzZXRTdGF0ZSgocHJldikgPT4gKHtcbiAgICAgICAgLi4ucHJldixcbiAgICAgICAgY3VycmVudFN0ZXA6IGNvbmRpdGlvbi5uYW1lLFxuICAgICAgfSkpO1xuXG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBQcm9taXNlLnJhY2UoW1xuICAgICAgICAgIFByb21pc2UucmVzb2x2ZShjb25kaXRpb24uY2hlY2soKSksXG4gICAgICAgICAgbmV3IFByb21pc2U8Ym9vbGVhbj4oKF8sIHJlamVjdCkgPT5cbiAgICAgICAgICAgIHNldFRpbWVvdXQoXG4gICAgICAgICAgICAgICgpID0+IHJlamVjdChuZXcgRXJyb3IoXCJUaW1lb3V0XCIpKSxcbiAgICAgICAgICAgICAgY29uZGl0aW9uLnRpbWVvdXQgfHwgREVGQVVMVF9USU1FT1VUXG4gICAgICAgICAgICApXG4gICAgICAgICAgKSxcbiAgICAgICAgXSk7XG5cbiAgICAgICAgYXdhaXQgZW5zdXJlTWluaW11bURpc3BsYXlUaW1lKCk7XG5cbiAgICAgICAgc2V0U3RhdGUoKHByZXYpID0+ICh7XG4gICAgICAgICAgLi4ucHJldixcbiAgICAgICAgICBzdGVwczogcHJldi5zdGVwcy5tYXAoKHN0ZXApID0+XG4gICAgICAgICAgICBzdGVwLmlkID09PSBjb25kaXRpb24uaWQgPyB7IC4uLnN0ZXAsIGNvbXBsZXRlZDogcmVzdWx0IH0gOiBzdGVwXG4gICAgICAgICAgKSxcbiAgICAgICAgfSkpO1xuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgYXdhaXQgZW5zdXJlTWluaW11bURpc3BsYXlUaW1lKCk7XG5cbiAgICAgICAgc2V0U3RhdGUoKHByZXYpID0+ICh7XG4gICAgICAgICAgLi4ucHJldixcbiAgICAgICAgICBzdGVwczogcHJldi5zdGVwcy5tYXAoKHN0ZXApID0+XG4gICAgICAgICAgICBzdGVwLmlkID09PSBjb25kaXRpb24uaWQgPyB7IC4uLnN0ZXAsIGNvbXBsZXRlZDogdHJ1ZSB9IDogc3RlcFxuICAgICAgICAgICksXG4gICAgICAgIH0pKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBDbGVhbiB1cCBhbmltYXRpb24gZnJhbWUgYW5kIGNvbXBsZXRlXG4gICAgaWYgKGFuaW1hdGlvbkZyYW1lSWQpIHtcbiAgICAgIGNhbmNlbEFuaW1hdGlvbkZyYW1lKGFuaW1hdGlvbkZyYW1lSWQpO1xuICAgIH1cblxuICAgIHNldFN0YXRlKChwcmV2KSA9PiAoe1xuICAgICAgLi4ucHJldixcbiAgICAgIGlzSW5pdGlhbExvYWRpbmc6IGZhbHNlLFxuICAgICAgcHJvZ3Jlc3M6IDEwMCxcbiAgICAgIGN1cnJlbnRTdGVwOiBcIlJlYWR5XCIsXG4gICAgfSkpO1xuICB9LCBbbG9hZGluZ0NvbmRpdGlvbnNdKTtcblxuICB1c2VFZmZlY3QoKCkgPT4ge1xuICAgIGNoZWNrTG9hZGluZ1N0ZXBzKCk7XG4gIH0sIFtjaGVja0xvYWRpbmdTdGVwc10pO1xuXG4gIGNvbnN0IGZvcmNlQ29tcGxldGUgPSB1c2VDYWxsYmFjaygoKSA9PiB7XG4gICAgc2V0U3RhdGUoKHByZXYpID0+ICh7XG4gICAgICAuLi5wcmV2LFxuICAgICAgaXNJbml0aWFsTG9hZGluZzogZmFsc2UsXG4gICAgICBwcm9ncmVzczogMTAwLFxuICAgICAgY3VycmVudFN0ZXA6IFwiUmVhZHlcIixcbiAgICB9KSk7XG4gIH0sIFtdKTtcblxuICBjb25zdCByZXN0YXJ0ID0gdXNlQ2FsbGJhY2soKCkgPT4ge1xuICAgIHNldFN0YXRlKHtcbiAgICAgIGlzSW5pdGlhbExvYWRpbmc6IHRydWUsXG4gICAgICBwcm9ncmVzczogMCxcbiAgICAgIGN1cnJlbnRTdGVwOiBcIlwiLFxuICAgICAgc3RlcHM6IFtdLFxuICAgICAgaXNTdXNwZW5zZUxvYWRpbmc6IGZhbHNlLFxuICAgIH0pO1xuICAgIGNoZWNrTG9hZGluZ1N0ZXBzKCk7XG4gIH0sIFtjaGVja0xvYWRpbmdTdGVwc10pO1xuXG4gIGNvbnN0IHNldFN1c3BlbnNlTG9hZGluZyA9IHVzZUNhbGxiYWNrKChsb2FkaW5nOiBib29sZWFuKSA9PiB7XG4gICAgc2V0U3RhdGUoKHByZXYpID0+ICh7IC4uLnByZXYsIGlzU3VzcGVuc2VMb2FkaW5nOiBsb2FkaW5nIH0pKTtcbiAgfSwgW10pO1xuXG4gIGNvbnN0IGlzT3ZlcmFsbExvYWRpbmcgPSBzdGF0ZS5pc0luaXRpYWxMb2FkaW5nIHx8IHN0YXRlLmlzU3VzcGVuc2VMb2FkaW5nO1xuXG4gIHJldHVybiB7XG4gICAgLi4uc3RhdGUsXG4gICAgaXNPdmVyYWxsTG9hZGluZyxcbiAgICBmb3JjZUNvbXBsZXRlLFxuICAgIHJlc3RhcnQsXG4gICAgc2V0U3VzcGVuc2VMb2FkaW5nLFxuICB9O1xufVxuIl0sInZlcnNpb24iOjN9